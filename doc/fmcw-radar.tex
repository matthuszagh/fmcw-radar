\documentclass{default}

% Allows hyperlinks to the included schematic.
\newcounter{includepdfpage}

\begin{document}

\tableofcontents
\hypersetup{linkcolor=red}

\chapter{Attribution \& Intent}
\label{cha:attribution}

This design is adapted from
\href{http://hforsten.com/third-version-of-homemade-6-ghz-fmcw-radar.html}{a blog post by Henrik
  Forst\'en}. A large portion of the design and schematics as well as parts of the description are
his and should be thus credited. I've made a number of modifications to the schematic and attempted
to thoroughly document the radar's operation in an effort to understand it. I hope that the
description below will be useful to others who want to understand how a radar can be built from
scratch but who, like me, are relatively new to electronics design.

\chapter{Physics}
\label{cha:overview}

\section{Range Calculation}
\label{sec:distance}

The principle of operation of an FMCW radar is shown in Fig.~\ref{fig:fmcw-principle}. A sinusoidal
signal that ramps in frequency is transmitted through air via an antenna. The reflected signal
(which is just a phase-shifted version of the original signal) is picked up by another antenna (or
set of antennas) and modulated with the original signal. The distance to the object can be computed
from the result, shown in Eq.~\ref{eq:fmcw-principle}, where $\Delta f$ is the frequency difference,
$t_{\text{ramp}}$ is the known ramp duration, $f_{\text{ramp}}$ is the difference between the high
and low ramp frequencies, $c$ is the speed of light and the 2 is present because the time measured
is the round-trip time.

\begin{figure}[h]
        \centering
        \includegraphics[width=0.75\textwidth]{data/fmcw-principle}
        \caption{FMCW radar operation: a delayed signal is modulated with the original signal and
          the distance to the remote object can be backed out from the phase difference between the
          two signals.}
        \label{fig:fmcw-principle}
\end{figure}

\begin{equation}
        \label{eq:fmcw-principle}
        d = \frac{c t_{\text{ramp}} \Delta f}{2 f_{\text{ramp}}}
\end{equation}

To calculate the frequency difference, we first express it in terms of the round-trip time,
$t_{\text{d}}$:

\begin{equation}
        \Delta f = \frac{t_{\text{d}} f_{\text{ramp}}}{t_{\text{ramp}}}
\end{equation}

The transmitted signal during one ramp is\footnote{It's acceptable to confine ourselves to a single
  ramp period for each object since the max distance we can detect with a $1 \si{ms}$ ramp period is
  about $150 \si{km}$, well beyond the radar's other physical limits.}:

\begin{align}
  s(t) &= T \sin\left(\omega t\right)  && \text{$T$ is the transmitted signal amplitude.} \\
       &= T \sin\left(2 \pi f(t) t\right) \\
       &= T \sin\left(2 \pi t \left( f_0 + t \frac{f_{\text{ramp}}}{t_{\text{ramp}}} \right) \right)
\end{align}

The received signal (which is just a phase shifted version of the transmitted signal) is
$s(t-t_{\text{d}})$. Using the mixer output we can compute the time delay:

\begin{align}
  m &= s(t) s(t-t_{\text{d}}) && \text{$m$ is the mixer output.} \\
    &= T \sin(\omega(t) t) R \sin(\omega (t-t_{\text{d}})(t-t_{\text{d}})) && \text{$R$ is the received signal amplitude.} \\
    &\approx T R \cos(\omega t_{\text{d}})/2 && \text{\footnotemark} \\
  t_{\text{d}} &\approx \frac{\arccos\left(\frac{2m}{T R}\right)}{2 \pi \left(f_0 + t \frac{f_{\text{ramp}}}{t_{\text{ramp}}} \right)}
\end{align}
\footnotetext{We've used the identity
  $\sin\theta\sin\phi = \left[\cos(\theta - \phi) - \cos(\theta + \phi)\right]/2$ and the fact that
  the sum term is well outside the \hyperref[sec:adl5802]{mixer} output IF range (as well as the
  subsequent \hyperref[sec:ada4940-2]{IF amplifier} pass-band) and will therefore be filtered out.}

The distance can be computed with Eq.~\ref{eq:fmcw-distance}.

\begin{equation}
        \label{eq:fmcw-distance}
        d = \frac{c \arccos\left(\frac{2m}{T R}\right)}{4 \pi \left(f_0 + t
                  \frac{f_{\text{ramp}}}{t_{\text{ramp}}} \right)}
\end{equation}

\fixme{The range equation needs to be adjusted for when the mixer product includes multiple received
  signals (use a Fourier transform to separate them) and possibly also for sinusoidal
  amplitudes. How does the sampling frequency affect the minimum detectable range? If we're
  performing a Fourier transform anyway, it might be better to leave
  $f_0 + t \frac{f_{\text{ramp}}}{t_{\text{ramp}}}$ as simply the frequency of the received
  signal. This must also account for the decomposed mixer output (for multiple received signals). To
  do this, it might be necessary to normalize all sinusoids before computing the distance.}

\section{Angle Calculation}
\label{sec:angle}



\chapter{Schematic}
\label{cha:schematic}

\include{power}
\include{top}
\include{fpga}
\include{usb}
\include{adc}
\include{tx}
\include{rx}
\include{mixer}
\include{if}

\chapter{PCB}
\label{cha:pcb}

\section{General Layout}

The radar is constructed using a 4-layer board and uses both surfaces of the board. The front layer
contains nearly all of the board's components while the back layer contains a few surface mount
resistors and capacitors. The top layer primarily contains signal traces for top layer SMD
components. In particular, it connects many of the signal traces of the ADC to the FPGA, which is
placed next to it. Note, however, that most of the signal traces extending from the FPGA only start
on the top layer but travel through layer 3. The buck converters and subsequent linear regulators
are placed near the top of the board, not necessarily near the components they drive. In addition to
the large number of signal traces, the top copper layer contains a large ground plane around the
periphery of the board. The 2nd layer is entirely a ground plane. The 3rd layer is largely a ground
plane, although it also contains a significant number of traces extending from the FPGA as well as a
few other components. The 4th layer primarily contains large power planes for each of the different
voltages driving logic in the design. It is worth noting that even though it contains significant
power planes, it still has a ground plane that is the largest copper fill zone in this layer. The
PCB also has 3 large corner mounting vias with smaller vias placed in a circle in the large via's
annular ring. The reason for the small vias is to ensure a continued connection to GND (the mounting
vias are connected to GND) even if a screw thread strips too much copper from the main
via. Additionally, it helps prevent the PCB from being crushed if too much torque is used to tighten
the screw. The 4th corner is occupied by the connections to the DC barrel jack. Power rail traces
are made 0.5mm in width whereas signal traces are 0.2mm in width. Grounded vias are placed liberally
throughout the design. They have a diameter of 0.46mm and a drill hole size of 0.254mm. I've
included several screenshots of the PCB and highlighted important components
(Figures~\ref{fig:fmcw-layer1-layout}, ~\ref{fig:fmcw-layer1-gnd}, ~\ref{fig:fmcw-layer2-gnd},
~\ref{fig:fmcw-layer3-gnd}, ~\ref{fig:fmcw-layer4-gnd}, ~\ref{fig:fmcw-layer4-12v},
~\ref{fig:fmcw-layer4-3v6}, ~\ref{fig:fmcw-layer4-3v0}, ~\ref{fig:fmcw-layer4-3v3a},
~\ref{fig:fmcw-layer4-3v3d}, ~\ref{fig:fmcw-layer4-5v}, ~\ref{fig:fmcw-layer4-5vf}).

\begin{figure}[h]
        \centering
        \includegraphics[width=\textwidth]{data/fmcw-layer1-layout.png}
        \caption{\textbf{Board layout}. The top left of the board is where the power source (barrel
          jack) is connected. The output of the 12V power source is connected to a power plane at
          the top left-middle of the board, that feeds into the buck converters. Large inductors
          connected to the buck converters are placed adjacent to their corresponding buck
          converters. The outputs of the buck converters feed into linear regulators that are mostly
          placed directly below the buck converters. This is also the region where the main crystal
          oscillator is placed and its associated fan-out buffer. Transmission circuitry (the
          frequency synthesizer and some RF amplifiers) are placed at the upper right side of the
          board near the antenna connectors which are placed on the right side of the
          board. Circuitry for signal reception are placed along the right side, adjacent to the
          antenna connectors. The mixer is placed slight inward from here, vertically centered but
          toward the right side of the board. Below this are intermediate frequency op-amps that
          feed the mixed signal into an ADC located just above it and to the left (U8). Located just
          to the left of the IF amplifiers and below the ADC is a flash memory IC (U40) which feeds
          data to the FPGA (U30), located just to the left of the ADC. Connectors below the FPGA (P3
          and P4) can be used to externally monitor the FPGA. In the bottom left of the board is a
          component to convert USB data to UART data to configure the FPGA as well as a micro USB
          connection to connect to a host computer. On the left side of the board between the USB
          connection and barrel jack is a SD card reader that stores data that can be read back out
          the FPGA.}
        \label{fig:fmcw-layer1-layout}
\end{figure}

\begin{figure}[h]
        \centering
        \includegraphics[width=\textwidth]{data/fmcw-layer1-gnd.png}
        \caption{A significant portion of layer 1 is a ground plane and the other large part of it
          is signal traces connecting components. There is also a small 1V power plane toward the
          upper left not highlighted here.}
        \label{fig:fmcw-layer1-gnd}
\end{figure}

\begin{figure}[h]
        \centering
        \includegraphics[width=\textwidth]{data/fmcw-layer2-gnd.png}
        \caption{All of layer 2 is a ground plane.}
        \label{fig:fmcw-layer2-gnd}
\end{figure}

\begin{figure}[h]
        \centering
        \includegraphics[width=\textwidth]{data/fmcw-layer3-gnd.png}
        \caption{Most of layer 3 is a ground plane but there are also a substantial number of trace
          connecting to the FPGA. It does also contain 1V an 3.3V power planes.}
        \label{fig:fmcw-layer3-gnd}
\end{figure}

\begin{figure}[h]
        \centering
        \includegraphics[width=\textwidth]{data/fmcw-layer4-gnd.png}
        \caption{The 4th layer of the PCB contains a large ground plane with many vias
          interspersed.}
        \label{fig:fmcw-layer4-gnd}
\end{figure}

\begin{figure}[h]
        \centering
        \includegraphics[width=\textwidth]{data/fmcw-layer4-12v.png}
        \caption{The 12V power plane is located at the top of the board adjacent to the D barrel
          jack and the buck converters it feeds.}
        \label{fig:fmcw-layer4-12v}
\end{figure}

\begin{figure}[h]
        \centering
        \includegraphics[width=\textwidth]{data/fmcw-layer4-3v6.png}
        \caption{There is a 3.6V power plane that is the output of one of the buck converter and is
          use as the input to several linear regulators that output 1.8V 3.0V and 3.3V.}
        \label{fig:fmcw-layer4-3v6}
\end{figure}

\begin{figure}[h]
        \centering\includegraphics[width=\textwidth]{data/fmcw-layer4-3v0.png}
        \caption{A 3V power plane is used to power components near the right side of the boar (the
          righside of the board is where signal transmission and reception occur that amplify
          receive signals so they can be mixed with the transmitted signal and fed into the ADC
          before FPGA processing Notably, the 3V power plane is located near the components but far
          from the linear regulator that outputs it.}
        \label{fig:fmcw-layer4-3v0}
\end{figure}

\begin{figure}[h]
        \centering\includegraphics[width=\textwidth ]{data/fmcw-layer4-3v3a.png}
        \caption{A 3.3V power plane is used to power several components for signal transmission,
          such as a frequency synthesizer, and RF amplifier. These, along with all other reception
          and transmission circuitry, are located on the right side of the board.}
        \label{fig:fmcw-layer4-3v3a}
\end{figure}

\begin{figure}[h]
        \centering\includegraphics[width=\textwidth]{data/fmcw-layer4-3v3d.png}
        \caption{Another 3.3V power plane is used as one of the power inputs to the FPGA as well as
          to a USB-to-UART device (a configuration bit stream is sent from a host computer through a
          USB cable to the PCB where this device converts it into the proper UART format to be
          transmitted to the FPGA) and an ADC (the ADC converts the mixed transmitted-received
          signals to digital and thensends them to the FPGA for processing).}
        \label{fig:fmcw-layer4-3v3d}
\end{figure}

\begin{figure}[h]
        \centering\includegraphics[width=\textwidth]{data/fmcw-layer4-5v.png}
        \caption{A 5V power plane powers one of the inputs to the frequency synthesizer for
          transmission.}
        \label{fig:fmcw-layer4-5v}
\end{figure}

\begin{figure}[h]
        \centering\includegraphics[width=\textwidth]{data/fmcw-layer4-5vf.png}
        \caption{Another 5V power plane is used for to power devices after going through a ferrite
          bead.}
        \label{fig:fmcw-layer4-5vf}
\end{figure}

\section{Component Layout Considerations}

\subsection{Power Input}
\label{sec:power-input-layout}

The barrel jack used has an inner diameter of 2.1mm and an outer diameter of 5.5mm and should output
12V. Since barrel jack dimensions and voltage output vary widely, special attention should be given
to make sure the actual hook up matches these specifications.

The pi filter should be placed as close to the barrel jack connection as possible so as to minimize
crosstalk noise with the rest of the board.

All components should be placed sufficiently close to the TPS5420D buck converter, except for the
trace between the voltage divider and VSNS which should be given a sufficiently wide berth from the
PH trace.

\subsection{LTC2292 ADC}

\begin{itemize}
\item The LTC2292 contains 4 positive voltage supply pins each requiring a 0.1$\mu$F bypass
        capacitor. One capacitor each should be placed directly adjacent to each of the 4 voltage
        supply pins.
\item The device contains 2 input pins for the voltage of the device where the output data is
        sent. These, similarly require a 0.1$\mu$F capacitor each. As before they should be placed
        next to their respective pins, not next to one another.
\item VCMA and VCMB each are connected to a 2.2$\mu$F capacitor to GND\@. They should be placed as
        close to the pins as possible.
\item REFHA and REFLA (and REFHB and REFLB) have a 0.1$\mu$F capacitor connected between them. These
        are the most critical capacitors connected to the ADC\@. They must be placed 1.5mm away at
        most, and preferably closer to the pins.
\end{itemize}

\subsection{RX1 / RX2}

\begin{itemize}
\item The 100pF capacitor used to bypass TRF37A73 should be place as close as possible to VCC\@.
\end{itemize}

\section{Board Layout}
\label{sec:board-layout}

There should be a section here on board layout. I.e.\ signal plane, ground plane, power plane,
etc. See High Speed Digital Design for recommendations. Also calculate the capacitance between the
power and ground plane. Btw, this is a great way to further filter noise from the power supplies.

\fixme{I'm not exactly sure where it should go, but there should be a section that documents the use
of vias, especially for high speed signals. Use page 258 of High Speed Logic to calculate the step
response, and present the results here. Additionally, mention via best practices such as placing an
adjacent ground via to any signal via to provide a current return path. Also, the use a multiple
small vias instead of one large one to minimize inductance. While we're at it, it's probably also
good to calculate trace inductance for certain important signals. I'm not sure where the equation
for this is, but it should be in High Speed Design.}

\section{RF Impedance Matching}

Document \href{https://en.wikipedia.org/wiki/Via_fence}{via fencing} used. Note the general rule
that spacing between vias should not be more than the RF wavelength divided by 20. I believe the
wavelength is 5cm, but check this and then put this in the documentation. For the impedance line
width I've decided to go with the original design's 14.96mil. I'm a little skeptical of the Mantaro
tool below which seems to not calculate effective impedance. Saturn PCB should be pretty good, and
if you can get OpenEMS to do this that would be the best.

Also document the RF via. Note the parallel ground trace running below it (and the ground plane
above it).

\fixme{I don't think the text below is correct.}.

I'm keeping it for the value of knowing the trace widths used by the original design. However, the
idea that the trace widths are unimportant seems dubious. The PCB calculator built into KiCad should
be used for this. Additionally, it is probably worth looking at the following guides:
\href{https://www.maximintegrated.com/en/app-notes/index.mvp/id/5100#}{Maxim: General Layout
  Guidelines for RF and Mixed-Signal PCBs},
\href{https://hackaday.com/2016/03/23/michael-ossmann-makes-you-an-rf-design-hero/}{Hackaday:
  Michael Ossmann makes you an RF design hero},
\href{https://www.analog.com/media/en/training-seminars/design-handbooks/Basic-Linear-Design/Chapter12.pdf}{Analog}. I
would also look at \href{https://github.com/erichVK5/WilkinsonPowerDividerFootprintGenerator}{this
  tool} for creating a Wilkinson power divider. Also, the trace width for $50\si{\Omega}$ resistors
seems to have been more like 15mil.

Use \href{http://www.mantaro.com/resources/impedance-calculator.htm}{this Mantaro impedance
  calculator} to calculate trace widths. The proper width should be 11.98mil.

The right side of the board houses the RF circuitry (i.e. transmitter, receivers and SMA
connectors). The signals are carried to the antennas (a patch-fed horn for transmission and a patch
array for reception) via a $50\si{\Omega}$ coaxial cable. All RF inputs and outputs for components
should match this $50\si{\Omega}$ impedance. The original layout does not seem overly concerned with
the microstrip transmission line width between RF components. They are kept short and generally have
a trace width of about 0.3mm. However, many of them are not even remotely straight and this doesn't
seem to be an issue. Where possible the microstrips should be kept short, straight and with an
unbroken ground plane beneath them. That seems to be all that is necessary for impedance
matching. The patch antennas however will need to be appropriately hooked up in order to match the
$50\si{\Omega}$ impedance. This should be a relatively straightforward calculation. The setup Henrik
uses seems to be the most logical one. He uses a single patch-fed horn antenna for transmission and
a patch array for reception. The horn antenna is made of thin copper. More sophisticated horn
antennas require the ability to weld and probably modeling software (e.g. CST).

\chapter{Antennas}
\label{cha:antennas}

There are several promising places to start in learning how to do this. Obviously, the
\href{hforsten.com}{hforsten blog} is a good place. Contextual Electronics also has a
\href{https://www.youtube.com/watch?v=m0B-63Q-R_8}{youtube video} about building a PCB
antenna. Finally, \href{http://openems.de/index.php/Main_Page.html}{OpenEMS} is apparently a very
powerful tool for simulating and designing antennas (among other things RF). This is already
installed and can be scripted through Octave. Make sure to look at the tutorials.

One antenna is used for transmission and two are used for reception. It might be possible to achieve
the same effect with two overall antennas but the design would need to be significantly altered to
do so. The transmission antenna should have high gain and high directivity. This ensures sufficient
power for reception, longer range, and less side clutter (i.e. you don't want a wide field of
vision, you want this to be mostly directed in a single direction). We use two reception antennas
instead of one so that we can perform beamforming. Basically, we mix the signal picked up by each
reception antenna individually with the transmitted signal. Each of these mixed products tells us
the distance from the object. However, if the object is at a slight angle, the phase difference
between the two mixed products tells us the incident angle, so we can localize the distant object.

\href{https://assets.lairdtech.com/home/brandworld/files/ANT-DS-PA58\%201115.pdf}{This antenna}
looks like it would be good for
transmission. \href{https://shop.bizsyscon.com/rf-elements-sh-cc-5-30-symmetrical-horn-carrier-class-30-degree.html#horizontalTab1}{This
  RF Elements} antenna looks even better, but is more than I'm willing to pay (and its gain is
lower,
however). \href{https://smile.amazon.com/d/Sewing-Machines-Accessories/9-4dBi-Triple-Antenna-Terminator-RJX1749/B074PR4TW3/ref=sr_1_8?ie=UTF8&qid=1544680544&sr=8-8&keywords=patch+antenna}{The
  Triple Feed Patch Array Antenna} is a great deal for the price and is based off a clever
open-source design,
\href{http://www.maartenbaert.be/quadcopters/antennas/triple-feed-patch-array-antenna/}{here}. I'm
not sure if the gain will be quite enough, however. If you're confused about the operation of that
last one, look at the description for it on Antenna Test Lab. They provide excellent
information. I'm mostly struggling to find a good patch array antenna for reception. I may have to
just build this myself, but I'm worried about the quality using normal FR4.

\begin{appendices}

\include{pinouts}

\chapter{Links}
\label{cha:links}


\chapter{Full Schematic}
\label{cha:schematic}

\includepdf[pages=-, link, linkname=schematic, landscape=true, angle=-90,
pagecommand={\refstepcounter{includepdfpage}\label{schematic.\theincludepdfpage}}]{data/fmcw-schematic.pdf}

\end{appendices}

\end{document}
%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
