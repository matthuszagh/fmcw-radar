#+title: FMCW Radar

* overview
** block diagram
\begin{tikzpicture}
\draw
(1,1) -- (0,0) -- (-1,1);
\draw[thick,rounded corners=8pt]
(0,0) -- (0,-2);
\end{tikzpicture}
** physics
This FMCW radar can compute the 2-dimensional position to remote
objects. It does this by computing the range and angle. Unlike some
other radars, this radar does not measure doppler shift and as a
result does not directly measure the speed of remote objects. However,
the speed can be computed by taking the change in position over time.

*** range
The distance computation is performed by measuring the time between
when a signal is transmitted and when it is received after having
bounced off a remote object. Using the relationship between the speed
of light and time of travel, we can back out the distance to a remote
target.

\begin{equation*}
d = \frac{ct_d}{2}
\end{equation*}

In order to measure the round-trip travel time, we transmit a
sinusoidal signal that ramps in frequency at a predetermined rate
between predetermined start and stop frequencies. The frequency-time
graph of the transmitted and received signals is shown below.



*** angle
* components
** USB interface
A FT2232H chip is used to pass data between the host PC and FPGA. It
is used in 245 synchronous FIFO mode, which allows USB 2.0 high-speed
transfer rates (60MB/s).

*** write transaction
A write transaction transmits data from the FPGA to the host PC.

**** timing details
The FPGA sends the FT2232H chip data for transmission using the 8-bit
ADBUS channel. The FT2232H registers this data and sends it over the
DM and DP USB data lines to the PC. FT2232H signals that it can
receive new data for transmission by driving the TXE# line low. When
the TXE# line is low, the FPGA can signal data for transmission by
driving the WR# line low and making the data available on the ADBUS
channel.

#+caption: FT2232H write transaction timing diagram. The setup time
#+caption: for WR# and ADBUS0 is between 1/2 and 1 clock period.

\begin{tikztimingtable}[%
  timing/dslope=0.1,
  timing/.style={x=5ex,y=2ex},
  x=5ex,
  timing/rowdist=3ex,
  timing/name/.style={font=\sffamily\scriptsize}
]
\busref{CLKOUT (60MHz)} & 25{c} \\
\busref{TXE\#}          & 3h 20l 2h \\
\busref{WR\#}           & 5h 18l 2h \\
\busref{ADBUS[7:0]}     & 5x 3d{0} 2d{1} 2d{2} 2d{3} 2d{4} 2d{5} 2d{6} 2d{7} 3x \\
\extracode
  \begin{pgfonlayer}{background}
    \begin{scope}[thick]
      \vertlines[blue]{3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5}
    \end{scope}
  \end{pgfonlayer}
\end{tikztimingtable}

*** read transaction
A read transaction sends data from the host PC to the FPGA.

** receiver
** digitization
The ADC reads both analog input channels simultaneously and
multiplexes the digital output on its 12-bit digital output
channel. Channel A data is output roughly in line with the clock at
high voltage and channel B is output roughly in line with the clock at
low voltage.

** signal processing
The FPGA receives a 12-bit sample from each channel every 25ns (40MHz)
over a sweep duration of 1ms. Following the 1ms sweep, no data is
received for 2ms after which the process repeats.

*** big ideas
Start by sampling data, each antenna pair in turn. It would also be a
good idea to average over several samples rather than just taking one
sample for each antenna pair. This should help reduce noise. Use the
frequency synthesizer delay to compute the FFT for each sample
sequence. Although this is subject to change, I imagine this going
something like:

Gather data for each antenna pair (should take about 1ms) in turn and
there is no reason to delay between acquisitions. When all antenna
pairs have data acquired, gather again for each pair. Try to perform
the FIR filter and downsampling while acquiring data. It might be
impossible to perform the FIR filter in real-time since a 120-tap
filter takes 120 multiplies (240 multiplies across both
antennas). That's probably more than I have, although I might be able
to do this on a bigger, pin-compatible FPGA. The benefit of
downsampling immediately is that you can store less intermediate data
(for averaging step). Acquire data from the same antenna pairs 2 or 4
times and average values (make sure this is a power of 2 so that the
average just involves a sum and bit shift). Investigate whether a
kaiser window is needed and if so do it. Then compute the fourier
transforms for all 8 sample sequences (each sequence will probably be
1024 data points of 16 bits each). It's hard to say how long this
should take since it depends on how resource-intensive the process is,
and the resources I have on the FPGA. The harder it is to perform, the
longer it will take.

Let's try at a rough estimate. Each FFT stage requires 3N/2
multiplies. For N=1024, this means 1536 multiplies per stage for 10
stages, or a total of 15,360 multiplies. If I can only do 8 multiplies
per clock (25ns clock period and 1 for each sequence), it would take
384us. Not bad.

The next step is to take an FFT across the angle dimension. This would
take 1024 FFTs of length 100 each. Using the same estimate assumptions
as before, this should take 1,536,000 multiplies or 38.4ms. Really not
bad.

Then I need to convert all my frequencies to distances. Not sure how
long this will take, but should be quicker than FFTs. Finally I need
to send data to the PC. I have 1024 distances for each angle of 100
anges, at 16 bit precision each. This is about 204kB. I need to send
this over USB 2.0 high speed to the PC at 60MB/s, which should only
take 3.4ms. All together, this gives me tons of extra time if trying
to get 1 full graph to the PC each second. I haven't included PC
plotting time, but that doesn't take FPGA resources and should be less
than 1 second in any case.

**** investigate
Can I configure the frequency synthesizer to give me a power-of-2
number of samples? I.e. 1024, rather than 1000?

*** filters
**** finite-impulse response
The FPGA first performs an FIR filter on the input data from each
channel. This reduces the strength of any signal frequencies above
2MHz. The filter is implemented as a timewise convolution in real-time
as the singal is sampled.

**** kaiser window
After the FIR filter, a kaiser window is applied to the sample. This
also occurs in real-time on the sample and involves a simple pointwise
multiplication of each kaiser window coefficient by each sample.

Should this be performed before decimating?

***** TODO clarify
Usually, kaiser windows are used to create FIRs. How is it that we can
pointwise multiply the sample by the window coefficients rather than
computing a convolution? Check the numpy documentation and the kiaser
window section in Discrete-Time Signal Processing.

*** downsampling
In order to make our data easier to process, we decimate it down to
2MHz. This leaves us with 2000 samples per channel per 3ms.

**** TODO correspondence b/e new frequency and max distance

*** fft
**** R2^{2}SDF FFT
***** example

\begin{latex}
\tikzset{
  s0bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/7,1.65/6,2.05/5,2.45/4,2.85/3,3.25/2,3.65/1,4.05/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45,2.85,3.25,3.65,4.05} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,-,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-,color=white] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-,color=white] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5) node[left] {\texttt{x\_re(15) ... x\_re(1) x\_re(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:7)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5) node[left] {\texttt{x\_im(15) ... x\_im(1) x\_im(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:8)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel0i}$};
  }
}
\tikzset{
  s0bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/3,1.65/2,2.05/1,2.45/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,--,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:5.4)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:6.4)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel0ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,color=white,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right,color=white]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel0i}$};
    \draw (myand.in 2) to[short,-*,color=white] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-,color=white] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\tikzset{
  s1bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/1,1.65/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,-,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-,color=white] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-,color=white] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:2.5);
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.6)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1)
      to[short,-,color=white] ++(180:1.5) --++(90:0.85) --++(180:1);
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.6)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel1i}$};
  }
}
\tikzset{
  s1bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,--,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.2)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.2)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel1ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,color=white,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right,color=white]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel1i}$};
    \draw (myand.in 2) to[short,-*,color=white] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-,color=white] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\begin{inctext}
\begin{circuitikz}
  %%% stage 0 BF1
  \path(0,0) pic{s0bf1};
  %%% stage 0 BF2
  \path(7,0) pic{s0bf2};
  %%% mixer
  \draw (12,-2) node[mixer,color=white,scale=1.5] (mix0) {};
  \draw (mix0.south) node[inputarrow,rotate=90,color=white] --++(0,-1)
    node[below] {\texttt{W1(n)}};
  \draw (mix0.east)++(-0.08,0.25) to[short,-,l=$\texttt{re}$] ++(0.85,0) node[inputarrow,color=white];
  \draw (mix0.east)++(-0.08,-0.25) to[short,-,l=$\texttt{im}$] ++(0.85,0) node[inputarrow,color=white];
  %%% register
  \draw (13.5,-2) to[twoport,t=\texttt{REG},color=white] (14.5,-2);
  \fill[white] (14-0.1,-2.5) --++(0.2,0) --++(-0.1,0.2) --cycle;
  \draw(15,-1.8) node[above] {\texttt{re}};
  \draw(15,-2.2) node[below] {\texttt{im}};
  %%% stage 1 BF1
  \path(18,0) pic{s1bf1};
  %%% stage 1 BF2
  \path(25,0) pic{s1bf2};

\end{circuitikz}
\end{inctext}
\end{latex}

****** interactive walkthrough

Propagated multiplexor inputs are colored. However, I omit the color when irrelevant.


\begin{latex}
\tikzset{
  s0bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/7,1.65/6,2.05/5,2.45/4,2.85/3,3.25/2,3.65/1,4.05/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45,2.85,3.25,3.65,4.05} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,-,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-,color=white] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-,color=white] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5) node[left] {\texttt{x\_re(15) ... x\_re(1) x\_re(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:7)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5) node[left] {\texttt{x\_im(15) ... x\_im(1) x\_im(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:8)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel0i}$};
  }
}
\tikzset{
  s0bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/3,1.65/2,2.05/1,2.45/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,--,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:5.4)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:6.4)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel0ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,color=white,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right,color=white]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel0i}$};
    \draw (myand.in 2) to[short,-*,color=white] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-,color=white] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\tikzset{
  s1bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/1,1.65/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,-,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-,color=white] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-,color=white] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:2.5);
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.6)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1)
      to[short,-,color=white] ++(180:1.5) --++(90:0.85) --++(180:1);
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.6)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel1i}$};
  }
}
\tikzset{
  s1bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,--,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.2)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.2)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel1ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,color=white,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right,color=white]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel1i}$};
    \draw (myand.in 2) to[short,-*,color=white] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-,color=white] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\begin{inctext}
\begin{circuitikz}
  %%% stage 0 BF1
  \path(0,0) pic{s0bf1};
  %%% stage 0 BF2
  \path(7,0) pic{s0bf2};
  %%% mixer
  \draw (12,-2) node[mixer,color=white,scale=1.5] (mix0) {};
  \draw (mix0.south) node[inputarrow,rotate=90,color=white] --++(0,-1)
    node[below] {\texttt{W1(n)}};
  \draw (mix0.east)++(-0.08,0.25) to[short,-,l=$\texttt{re}$] ++(0.85,0) node[inputarrow,color=white];
  \draw (mix0.east)++(-0.08,-0.25) to[short,-,l=$\texttt{im}$] ++(0.85,0) node[inputarrow,color=white];
  %%% register
  \draw (13.5,-2) to[twoport,t=\texttt{REG},color=white] (14.5,-2);
  \fill[white] (14-0.1,-2.5) --++(0.2,0) --++(-0.1,0.2) --cycle;
  \draw(15,-1.8) node[above] {\texttt{re}};
  \draw(15,-2.2) node[below] {\texttt{im}};
  %%% stage 1 BF1
  \path(18,0) pic{s1bf1};
  %%% stage 1 BF2
  \path(25,0) pic{s1bf2};

\end{circuitikz}
\end{inctext}
\end{latex}
sel0i  : 9-16
sel0ii : 13-24
sel1i  : 15-28
sel1ii : 16-30

twiddle factors:
w(0)  :  1.000-0.000j
w(1)  :  1.000-0.000j
w(2)  :  1.000-0.000j
w(3)  :  1.000-0.000j
w(4)  :  1.000-0.000j
w(5)  :  0.707-0.707j
w(6)  :  0.000-1.000j
w(7)  : -0.707-0.707j
w(8)  :  1.000-0.000j
w(9)  :  0.923-0.382j
w(10) :  0.707-0.707j
w(11) :  0.382-0.923j
w(12) :  1.000-0.000j
w(13) :  0.382-0.923j
w(14) : -0.707-0.707j
w(15) : -0.923+0.382j

|               t |  0  |    1    |    2    |    3    |    4    |    5    |    6    |    7    |    8    |
|             <r> | <c> |   <c>   |   <c>   |   <c>   |   <c>   |   <c>   |   <c>   |   <c>   |   <c>   |
|-----------------+-----+---------+---------+---------+---------+---------+---------+---------+---------|
|           sel0i |     |         |         |         |         |         |         |         |         |
|          sel0ii |     |         |         |         |         |         |         |         |         |
|           sel1i |     |         |         |         |         |         |         |         |         |
|          sel1ii |     |         |         |         |         |         |         |         |         |
|-----------------+-----+---------+---------+---------+---------+---------+---------+---------+---------|
| s0bf1\under{}fsr\under{}re[0] |     | x\under{}re[0] | x\under{}re[1] | x\under{}re[2] | x\under{}re[3] | x\under{}re[4] | x\under{}re[5] | x\under{}re[6] | x\under{}re[7] |
| s0bf1\under{}fsr\under{}im[0] |     | x\under{}im[0] | x\under{}im[1] | x\under{}im[2] | x\under{}im[3] | x\under{}im[4] | x\under{}im[5] | x\under{}im[6] | x\under{}im[7] |
| s0bf1\under{}fsr\under{}re[1] |     |         | x\under{}re[0] | x\under{}re[1] | x\under{}re[2] | x\under{}re[3] | x\under{}re[4] | x\under{}re[5] | x\under{}re[6] |
| s0bf1\under{}fsr\under{}im[1] |     |         | x\under{}im[0] | x\under{}im[1] | x\under{}im[2] | x\under{}im[3] | x\under{}im[4] | x\under{}im[5] | x\under{}im[6] |
| s0bf1\under{}fsr\under{}re[2] |     |         |         | x\under{}re[0] | x\under{}re[1] | x\under{}re[2] | x\under{}re[3] | x\under{}re[4] | x\under{}re[5] |
| s0bf1\under{}fsr\under{}im[2] |     |         |         | x\under{}im[0] | x\under{}im[1] | x\under{}im[2] | x\under{}im[3] | x\under{}im[4] | x\under{}im[5] |
| s0bf1\under{}fsr\under{}re[3] |     |         |         |         | x\under{}re[0] | x\under{}re[1] | x\under{}re[2] | x\under{}re[3] | x\under{}re[4] |
| s0bf1\under{}fsr\under{}im[3] |     |         |         |         | x\under{}im[0] | x\under{}im[1] | x\under{}im[2] | x\under{}im[3] | x\under{}im[4] |
| s0bf1\under{}fsr\under{}re[4] |     |         |         |         |         | x\under{}re[0] | x\under{}re[1] | x\under{}re[2] | x\under{}re[3] |
| s0bf1\under{}fsr\under{}im[4] |     |         |         |         |         | x\under{}im[0] | x\under{}im[1] | x\under{}im[2] | x\under{}im[3] |
| s0bf1\under{}fsr\under{}re[5] |     |         |         |         |         |         | x\under{}re[0] | x\under{}re[1] | x\under{}re[2] |
| s0bf1\under{}fsr\under{}im[5] |     |         |         |         |         |         | x\under{}im[0] | x\under{}im[1] | x\under{}im[2] |
| s0bf1\under{}fsr\under{}re[6] |     |         |         |         |         |         |         | x\under{}re[0] | x\under{}re[1] |
| s0bf1\under{}fsr\under{}im[6] |     |         |         |         |         |         |         | x\under{}im[0] | x\under{}im[1] |
| s0bf1\under{}fsr\under{}re[7] |     |         |         |         |         |         |         |         | x\under{}re[0] |
| s0bf1\under{}fsr\under{}im[7] |     |         |         |         |         |         |         |         | x\under{}im[0] |
|-----------------+-----+---------+---------+---------+---------+---------+---------+---------+---------|
| s0bf2\under{}fsr\under{}re[0] |     |         |         |         |         |         |         |         |         |
| s0bf2\under{}fsr\under{}im[0] |     |         |         |         |         |         |         |         |         |
| s0bf2\under{}fsr\under{}re[1] |     |         |         |         |         |         |         |         |         |
| s0bf2\under{}fsr\under{}im[1] |     |         |         |         |         |         |         |         |         |
| s0bf2\under{}fsr\under{}re[2] |     |         |         |         |         |         |         |         |         |
| s0bf2\under{}fsr\under{}im[2] |     |         |         |         |         |         |         |         |         |
| s0bf2\under{}fsr\under{}re[3] |     |         |         |         |         |         |         |         |         |
| s0bf2\under{}fsr\under{}im[3] |     |         |         |         |         |         |         |         |         |
|-----------------+-----+---------+---------+---------+---------+---------+---------+---------+---------|
| s1bf1\under{}fsr\under{}re[0] |     |         |         |         |         |         |         |         |         |
| s1bf1\under{}fsr\under{}im[0] |     |         |         |         |         |         |         |         |         |
| s1bf1\under{}fsr\under{}re[1] |     |         |         |         |         |         |         |         |         |
| s1bf1\under{}fsr\under{}im[1] |     |         |         |         |         |         |         |         |         |
|-----------------+-----+---------+---------+---------+---------+---------+---------+---------+---------|
| s1bf2\under{}fsr\under{}re[0] |     |         |         |         |         |         |         |         |         |
| s1bf2\under{}fsr\under{}im[0] |     |         |         |         |         |         |         |         |         |

\begin{latex}
\usetikzlibrary{backgrounds}
\tikzset{
  s0bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/7,1.65/6,2.05/5,2.45/4,2.85/3,3.25/2,3.65/1,4.05/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[black] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45,2.85,3.25,3.65,4.05} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33)
      to[short,-] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-] ++(180:1.5) node[left] {\texttt{x\_re(15) ... x\_re(1) x\_re(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:7)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-] ++(180:1.5) node[left] {\texttt{x\_im(15) ... x\_im(1) x\_im(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:8)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel0i}$};
  }
}
\tikzset{
  s0bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/3,1.65/2,2.05/1,2.45/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[black] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33)
      to[short,--] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:5.4)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:6.4)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel0ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel0i}$};
    \draw (myand.in 2) to[short,-*] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\tikzset{
  s1bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/1,1.65/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[black] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33)
      to[short,-] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-] ++(180:2.5);
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.6)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1)
      to[short,-] ++(180:1.5) --++(90:0.85) --++(180:1);
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.6)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel1i}$};
  }
}
\tikzset{
  s1bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[black] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33)
      to[short,--] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.2)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow] --++(180:0.35)
      to[short,-*] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.2)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel1ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel1i}$};
    \draw (myand.in 2) to[short,-*] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\begin{inctext}
\begin{circuitikz}[background rectangle/.style={fill=white}, show background rectangle]
  %%% stage 0 BF1
  \path(0,0) pic{s0bf1};
  %%% stage 0 BF2
  \path(7,0) pic{s0bf2};
  %%% mixer
  \draw (12,-2) node[mixer,scale=1.5] (mix0) {};
  \draw (mix0.south) node[inputarrow,rotate=90] --++(0,-1)
    node[below] {\texttt{W1(n)}};
  \draw (mix0.east)++(-0.08,0.25) to[short,-,l=$\texttt{re}$] ++(0.85,0) node[inputarrow];
  \draw (mix0.east)++(-0.08,-0.25) to[short,-,l=$\texttt{im}$] ++(0.85,0) node[inputarrow];
  %%% register
  \draw (13.5,-2) to[twoport,t=\texttt{REG}] (14.5,-2);
  \fill[black] (14-0.1,-2.5) --++(0.2,0) --++(-0.1,0.2) --cycle;
  \draw(15,-1.8) node[above] {\texttt{re}};
  \draw(15,-2.2) node[below] {\texttt{im}};
  %%% stage 1 BF1
  \path(18,0) pic{s1bf1};
  %%% stage 1 BF2
  \path(25,0) pic{s1bf2};

\end{circuitikz}
\end{inctext}
\end{latex}

sel0i  : 9-16
sel0ii : 13-24
sel1i  : 15-28
sel1ii : 16-30

twiddle factors:
w(0)  :  1.000-0.000j
w(1)  :  1.000-0.000j
w(2)  :  1.000-0.000j
w(3)  :  1.000-0.000j
w(4)  :  1.000-0.000j
w(5)  :  0.707-0.707j
w(6)  :  0.000-1.000j
w(7)  : -0.707-0.707j
w(8)  :  1.000-0.000j
w(9)  :  0.923-0.382j
w(10) :  0.707-0.707j
w(11) :  0.382-0.923j
w(12) :  1.000-0.000j
w(13) :  0.382-0.923j
w(14) : -0.707-0.707j
w(15) : -0.923+0.382j

|               t |   ...   |         9         |        10         |         11         |         12         |
|             <r> |   <c>   |        <c>        |        <c>        |        <c>         |        <c>         |
|-----------------+---------+-------------------+-------------------+--------------------+--------------------|
|           sel0i |         |         1         |         1         |         1          |         1          |
|          sel0ii |         |                   |                   |                    |                    |
|           sel1i |         |                   |                   |                    |                    |
|          sel1ii |         |                   |                   |                    |                    |
|-----------------+---------+-------------------+-------------------+--------------------+--------------------|
| s0bf1\under{}fsr\under{}re[0] | x\under{}re[7] | x\under{}re[0] - x\under{}re[8] | x\under{}re[1] - x\under{}re[9] | x\under{}re[2] - x\under{}re[10] | x\under{}re[3] - x\under{}re[11] |
| s0bf1\under{}fsr\under{}im[0] | x\under{}im[7] | x\under{}im[0] - x\under{}im[8] | x\under{}im[1] - x\under{}im[9] | x\under{}im[2] - x\under{}im[10] | x\under{}im[3] - x\under{}im[11] |
| s0bf1\under{}fsr\under{}re[1] | x\under{}re[6] |      x\under{}re[7]      | x\under{}re[0] - x\under{}re[8] | x\under{}re[1] - x\under{}re[9]  | x\under{}re[2] - x\under{}re[10] |
| s0bf1\under{}fsr\under{}im[1] | x\under{}im[6] |      x\under{}im[7]      | x\under{}im[0] - x\under{}im[8] | x\under{}im[1] - x\under{}im[9]  | x\under{}im[2] - x\under{}im[10] |
| s0bf1\under{}fsr\under{}re[2] | x\under{}re[5] |      x\under{}re[6]      |      x\under{}re[7]      | x\under{}re[0] - x\under{}re[8]  | x\under{}re[1] - x\under{}re[9]  |
| s0bf1\under{}fsr\under{}im[2] | x\under{}im[5] |      x\under{}im[6]      |      x\under{}im[7]      | x\under{}im[0] - x\under{}im[8]  | x\under{}im[1] - x\under{}im[9]  |
| s0bf1\under{}fsr\under{}re[3] | x\under{}re[4] |      x\under{}re[5]      |      x\under{}re[6]      |      x\under{}re[7]       | x\under{}re[0] - x\under{}re[8]  |
| s0bf1\under{}fsr\under{}im[3] | x\under{}im[4] |      x\under{}im[5]      |      x\under{}im[6]      |      x\under{}im[7]       | x\under{}im[0] - x\under{}im[8]  |
| s0bf1\under{}fsr\under{}re[4] | x\under{}re[3] |      x\under{}re[4]      |      x\under{}re[5]      |      x\under{}re[6]       |      x\under{}re[7]       |
| s0bf1\under{}fsr\under{}im[4] | x\under{}im[3] |      x\under{}im[4]      |      x\under{}im[5]      |      x\under{}im[6]       |      x\under{}im[7]       |
| s0bf1\under{}fsr\under{}re[5] | x\under{}re[2] |      x\under{}re[3]      |      x\under{}re[4]      |      x\under{}re[5]       |      x\under{}re[6]       |
| s0bf1\under{}fsr\under{}im[5] | x\under{}im[2] |      x\under{}im[3]      |      x\under{}im[4]      |      x\under{}im[5]       |      x\under{}im[6]       |
| s0bf1\under{}fsr\under{}re[6] | x\under{}re[1] |      x\under{}re[2]      |      x\under{}re[3]      |      x\under{}re[4]       |      x\under{}re[5]       |
| s0bf1\under{}fsr\under{}im[6] | x\under{}im[1] |      x\under{}im[2]      |      x\under{}im[3]      |      x\under{}im[4]       |      x\under{}im[5]       |
| s0bf1\under{}fsr\under{}re[7] | x\under{}re[0] |      x\under{}re[1]      |      x\under{}re[2]      |      x\under{}re[3]       |      x\under{}re[4]       |
| s0bf1\under{}fsr\under{}im[7] | x\under{}im[0] |      x\under{}im[1]      |      x\under{}im[2]      |      x\under{}im[3]       |      x\under{}im[4]       |
|-----------------+---------+-------------------+-------------------+--------------------+--------------------|
| s0bf2\under{}fsr\under{}re[0] |         | x\under{}re[0] + x\under{}re[8] | x\under{}re[1] + x\under{}re[9] | x\under{}re[2] + x\under{}re[10] | x\under{}re[3] + x\under{}re[11] |
| s0bf2\under{}fsr\under{}im[0] |         | x\under{}im[0] + x\under{}im[8] | x\under{}im[1] + x\under{}im[9] | x\under{}im[2] + x\under{}im[10] | x\under{}im[3] + x\under{}im[11] |
| s0bf2\under{}fsr\under{}re[1] |         |                   | x\under{}re[0] + x\under{}re[8] | x\under{}re[1] + x\under{}re[9]  | x\under{}re[2] + x\under{}re[10] |
| s0bf2\under{}fsr\under{}im[1] |         |                   | x\under{}im[0] + x\under{}im[8] | x\under{}im[1] + x\under{}im[9]  | x\under{}im[2] + x\under{}im[10] |
| s0bf2\under{}fsr\under{}re[2] |         |                   |                   | x\under{}re[0] + x\under{}re[8]  | x\under{}re[1] + x\under{}re[9]  |
| s0bf2\under{}fsr\under{}im[2] |         |                   |                   | x\under{}im[0] + x\under{}im[8]  | x\under{}im[1] + x\under{}im[9]  |
| s0bf2\under{}fsr\under{}re[3] |         |                   |                   |                    | x\under{}re[0] + x\under{}re[8]  |
| s0bf2\under{}fsr\under{}im[3] |         |                   |                   |                    | x\under{}im[0] + x\under{}im[8]  |
|-----------------+---------+-------------------+-------------------+--------------------+--------------------|
| s1bf1\under{}fsr\under{}re[0] |         |                   |                   |                    |                    |
| s1bf1\under{}fsr\under{}im[0] |         |                   |                   |                    |                    |
| s1bf1\under{}fsr\under{}re[1] |         |                   |                   |                    |                    |
| s1bf1\under{}fsr\under{}im[1] |         |                   |                   |                    |                    |
|-----------------+---------+-------------------+-------------------+--------------------+--------------------|
| s1bf2\under{}fsr\under{}re[0] |         |                   |                   |                    |                    |
| s1bf2\under{}fsr\under{}im[0] |         |                   |                   |                    |                    |

\begin{latex}
\tikzset{
  s0bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/7,1.65/6,2.05/5,2.45/4,2.85/3,3.25/2,3.65/1,4.05/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45,2.85,3.25,3.65,4.05} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,-,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-,color=white] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-,color=white] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5) node[left] {\texttt{x\_re(15) ... x\_re(1) x\_re(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:7)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5) node[left] {\texttt{x\_im(15) ... x\_im(1) x\_im(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:8)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel0i}$};
  }
}
\tikzset{
  s0bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/3,1.65/2,2.05/1,2.45/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,--,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:5.4)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:6.4)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel0ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,color=white,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right,color=white]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel0i}$};
    \draw (myand.in 2) to[short,-*,color=white] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-,color=white] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\tikzset{
  s1bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/1,1.65/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,-,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-,color=white] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-,color=white] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:2.5);
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.6)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1)
      to[short,-,color=white] ++(180:1.5) --++(90:0.85) --++(180:1);
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.6)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel1i}$};
  }
}
\tikzset{
  s1bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,--,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.2)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.2)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel1ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,color=white,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right,color=white]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel1i}$};
    \draw (myand.in 2) to[short,-*,color=white] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-,color=white] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\begin{inctext}
\begin{circuitikz}
  %%% stage 0 BF1
  \path(0,0) pic{s0bf1};
  %%% stage 0 BF2
  \path(7,0) pic{s0bf2};
  %%% mixer
  \draw (12,-2) node[mixer,color=white,scale=1.5] (mix0) {};
  \draw (mix0.south) node[inputarrow,rotate=90,color=white] --++(0,-1)
    node[below] {\texttt{W1(n)}};
  \draw (mix0.east)++(-0.08,0.25) to[short,-,l=$\texttt{re}$] ++(0.85,0) node[inputarrow,color=white];
  \draw (mix0.east)++(-0.08,-0.25) to[short,-,l=$\texttt{im}$] ++(0.85,0) node[inputarrow,color=white];
  %%% register
  \draw (13.5,-2) to[twoport,t=\texttt{REG},color=white] (14.5,-2);
  \fill[white] (14-0.1,-2.5) --++(0.2,0) --++(-0.1,0.2) --cycle;
  \draw(15,-1.8) node[above] {\texttt{re}};
  \draw(15,-2.2) node[below] {\texttt{im}};
  %%% stage 1 BF1
  \path(18,0) pic{s1bf1};
  %%% stage 1 BF2
  \path(25,0) pic{s1bf2};

\end{circuitikz}
\end{inctext}
\end{latex}

sel0i  : 9-16
sel0ii : 13-24
sel1i  : 15-28
sel1ii : 16-30

twiddle factors:
w(0)  :  1.000-0.000j
w(1)  :  1.000-0.000j
w(2)  :  1.000-0.000j
w(3)  :  1.000-0.000j
w(4)  :  1.000-0.000j
w(5)  :  0.707-0.707j
w(6)  :  0.000-1.000j
w(7)  : -0.707-0.707j
w(8)  :  1.000-0.000j
w(9)  :  0.923-0.382j
w(10) :  0.707-0.707j
w(11) :  0.382-0.923j
w(12) :  1.000-0.000j
w(13) :  0.382-0.923j
w(14) : -0.707-0.707j
w(15) : -0.923+0.382j

|               t |        ...         |                   13                   |                   14                   |
|             <r> |        <c>         |                  <c>                   |                  <c>                   |
|-----------------+--------------------+----------------------------------------+----------------------------------------|
|           sel0i |         1          |                   1                    |                   1                    |
|          sel0ii |                    |                   1                    |                   1                    |
|           sel1i |                    |                                        |                                        |
|          sel1ii |                    |                                        |                                        |
|               w |                    |                  w(0)                  |                  w(1)                  |
|-----------------+--------------------+----------------------------------------+----------------------------------------|
| s0bf1\under{}fsr\under{}re[0] | x\under{}re[3] - x\under{}re[11] |           x\under{}re[4] - x\under{}re[12]           |           x\under{}re[5] - x\under{}re[13]           |
| s0bf1\under{}fsr\under{}im[0] | x\under{}im[3] - x\under{}im[11] |           x\under{}im[4] - x\under{}im[12]           |           x\under{}im[5] - x\under{}im[13]           |
| s0bf1\under{}fsr\under{}re[1] | x\under{}re[2] - x\under{}re[10] |           x\under{}re[3] - x\under{}re[11]           |           x\under{}re[4] - x\under{}re[12]           |
| s0bf1\under{}fsr\under{}im[1] | x\under{}im[2] - x\under{}im[10] |           x\under{}im[3] - x\under{}im[11]           |           x\under{}im[4] - x\under{}im[12]           |
| s0bf1\under{}fsr\under{}re[2] | x\under{}re[1] - x\under{}re[9]  |           x\under{}re[2] - x\under{}re[10]           |           x\under{}re[3] - x\under{}re[11]           |
| s0bf1\under{}fsr\under{}im[2] | x\under{}im[1] - x\under{}im[9]  |           x\under{}im[2] - x\under{}im[10]           |           x\under{}im[3] - x\under{}im[11]           |
| s0bf1\under{}fsr\under{}re[3] | x\under{}re[0] - x\under{}re[8]  |           x\under{}re[1] - x\under{}re[9]            |           x\under{}re[2] - x\under{}re[10]           |
| s0bf1\under{}fsr\under{}im[3] | x\under{}im[0] - x\under{}im[8]  |           x\under{}im[1] - x\under{}im[9]            |           x\under{}im[2] - x\under{}im[10]           |
| s0bf1\under{}fsr\under{}re[4] |      x\under{}re[7]       |           x\under{}re[0] - x\under{}re[8]            |           x\under{}re[1] - x\under{}re[9]            |
| s0bf1\under{}fsr\under{}im[4] |      x\under{}im[7]       |           x\under{}im[0] - x\under{}im[8]            |           x\under{}im[1] - x\under{}im[9]            |
| s0bf1\under{}fsr\under{}re[5] |      x\under{}re[6]       |                x\under{}re[7]                 |           x\under{}re[0] - x\under{}re[8]            |
| s0bf1\under{}fsr\under{}im[5] |      x\under{}im[6]       |                x\under{}im[7]                 |           x\under{}im[0] - x\under{}im[8]            |
| s0bf1\under{}fsr\under{}re[6] |      x\under{}re[5]       |                x\under{}re[6]                 |                x\under{}re[7]                 |
| s0bf1\under{}fsr\under{}im[6] |      x\under{}im[5]       |                x\under{}im[6]                 |                x\under{}im[7]                 |
| s0bf1\under{}fsr\under{}re[7] |      x\under{}re[4]       |                x\under{}re[5]                 |                x\under{}re[6]                 |
| s0bf1\under{}fsr\under{}im[7] |      x\under{}im[4]       |                x\under{}im[5]                 |                x\under{}im[6]                 |
|-----------------+--------------------+----------------------------------------+----------------------------------------|
| s0bf2\under{}fsr\under{}re[0] | x\under{}re[3] + x\under{}re[11] | x\under{}re[0] + x\under{}re[8] - x\under{}re[4] - x\under{}re[12] | x\under{}re[1] + x\under{}re[9] - x\under{}re[5] - x\under{}re[13] |
| s0bf2\under{}fsr\under{}im[0] | x\under{}im[3] + x\under{}im[11] | x\under{}im[0] + x\under{}im[8] - x\under{}im[4] - x\under{}im[12] | x\under{}im[1] + x\under{}im[9] - x\under{}im[5] - x\under{}im[13] |
| s0bf2\under{}fsr\under{}re[1] | x\under{}re[2] + x\under{}re[10] |           x\under{}re[3] + x\under{}re[11]           | x\under{}re[0] + x\under{}re[8] - x\under{}re[4] - x\under{}re[12] |
| s0bf2\under{}fsr\under{}im[1] | x\under{}im[2] + x\under{}im[10] |           x\under{}im[3] + x\under{}im[11]           | x\under{}im[0] + x\under{}im[8] - x\under{}im[4] - x\under{}im[12] |
| s0bf2\under{}fsr\under{}re[2] | x\under{}re[1] + x\under{}re[9]  |           x\under{}re[2] + x\under{}re[10]           |           x\under{}re[3] + x\under{}re[11]           |
| s0bf2\under{}fsr\under{}im[2] | x\under{}im[1] + x\under{}im[9]  |           x\under{}im[2] + x\under{}im[10]           |           x\under{}im[3] + x\under{}im[11]           |
| s0bf2\under{}fsr\under{}re[3] | x\under{}re[0] + x\under{}re[8]  |           x\under{}re[1] + x\under{}re[9]            |           x\under{}re[2] + x\under{}re[10]           |
| s0bf2\under{}fsr\under{}im[3] | x\under{}im[0] + x\under{}im[8]  |           x\under{}im[1] + x\under{}im[9]            |           x\under{}im[2] + x\under{}im[10]           |
|-----------------+--------------------+----------------------------------------+----------------------------------------|
| s1bf1\under{}fsr\under{}re[0] |                    | x\under{}re[0] + x\under{}re[8] + x\under{}re[4] + x\under{}re[12] | x\under{}re[1] + x\under{}re[9] + x\under{}re[5] + x\under{}re[13] |
| s1bf1\under{}fsr\under{}im[0] |                    | x\under{}im[0] + x\under{}im[8] + x\under{}im[4] + x\under{}im[12] | x\under{}im[1] + x\under{}im[9] + x\under{}im[5] + x\under{}im[13] |
| s1bf1\under{}fsr\under{}re[1] |                    |                                        | x\under{}re[0] + x\under{}re[8] + x\under{}re[4] + x\under{}re[12] |
| s1bf1\under{}fsr\under{}im[1] |                    |                                        | x\under{}im[0] + x\under{}im[8] + x\under{}im[4] + x\under{}im[12] |
|-----------------+--------------------+----------------------------------------+----------------------------------------|
| s1bf2\under{}fsr\under{}re[0] |                    |                                        |                                        |
| s1bf2\under{}fsr\under{}im[0] |                    |                                        |                                        |


\begin{latex}
\tikzset{
  s0bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/7,1.65/6,2.05/5,2.45/4,2.85/3,3.25/2,3.65/1,4.05/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45,2.85,3.25,3.65,4.05} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,-,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-,color=white] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-,color=white] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5) node[left] {\texttt{x\_re(15) ... x\_re(1) x\_re(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:7)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5) node[left] {\texttt{x\_im(15) ... x\_im(1) x\_im(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:8)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel0i}$};
  }
}
\tikzset{
  s0bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/3,1.65/2,2.05/1,2.45/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,--,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:5.4)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:6.4)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel0ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,color=white,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right,color=white]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel0i}$};
    \draw (myand.in 2) to[short,-*,color=white] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-,color=white] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\tikzset{
  s1bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/1,1.65/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,-,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-,color=white] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-,color=white] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:2.5);
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.6)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1)
      to[short,-,color=white] ++(180:1.5) --++(90:0.85) --++(180:1);
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.6)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel1i}$};
  }
}
\tikzset{
  s1bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,--,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.2)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.2)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel1ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,color=white,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right,color=white]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel1i}$};
    \draw (myand.in 2) to[short,-*,color=white] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-,color=white] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\begin{inctext}
\begin{circuitikz}
  %%% stage 0 BF1
  \path(0,0) pic{s0bf1};
  %%% stage 0 BF2
  \path(7,0) pic{s0bf2};
  %%% mixer
  \draw (12,-2) node[mixer,color=white,scale=1.5] (mix0) {};
  \draw (mix0.south) node[inputarrow,rotate=90,color=white] --++(0,-1)
    node[below] {\texttt{W1(n)}};
  \draw (mix0.east)++(-0.08,0.25) to[short,-,l=$\texttt{re}$] ++(0.85,0) node[inputarrow,color=white];
  \draw (mix0.east)++(-0.08,-0.25) to[short,-,l=$\texttt{im}$] ++(0.85,0) node[inputarrow,color=white];
  %%% register
  \draw (13.5,-2) to[twoport,t=\texttt{REG},color=white] (14.5,-2);
  \fill[white] (14-0.1,-2.5) --++(0.2,0) --++(-0.1,0.2) --cycle;
  \draw(15,-1.8) node[above] {\texttt{re}};
  \draw(15,-2.2) node[below] {\texttt{im}};
  %%% stage 1 BF1
  \path(18,0) pic{s1bf1};
  %%% stage 1 BF2
  \path(25,0) pic{s1bf2};

\end{circuitikz}
\end{inctext}
\end{latex}

sel0i  : 9-16
sel0ii : 13-24
sel1i  : 15-28
sel1ii : 16-30

twiddle factors:
w(0)  :  1.000-0.000j
w(1)  :  1.000-0.000j
w(2)  :  1.000-0.000j
w(3)  :  1.000-0.000j
w(4)  :  1.000-0.000j
w(5)  :  0.707-0.707j
w(6)  :  0.000-1.000j
w(7)  : -0.707-0.707j
w(8)  :  1.000-0.000j
w(9)  :  0.923-0.382j
w(10) :  0.707-0.707j
w(11) :  0.382-0.923j
w(12) :  1.000-0.000j
w(13) :  0.382-0.923j
w(14) : -0.707-0.707j
w(15) : -0.923+0.382j

|               t |                  ...                   |                                        15                                        |
|             <r> |                  <c>                   |                                       <c>                                        |
|-----------------+----------------------------------------+----------------------------------------------------------------------------------|
|           sel0i |                   1                    |                                        1                                         |
|          sel0ii |                   1                    |                                        1                                         |
|           sel1i |                                        |                                        1                                         |
|          sel1ii |                                        |                                                                                  |
|               w |                  w(1)                  |                                       w(2)                                       |
|-----------------+----------------------------------------+----------------------------------------------------------------------------------|
| s0bf1\under{}fsr\under{}re[0] |           x\under{}re[5] - x\under{}re[13]           |                                x\under{}re[6] - x\under{}re[14]                                |
| s0bf1\under{}fsr\under{}im[0] |           x\under{}im[5] - x\under{}im[13]           |                                x\under{}im[6] - x\under{}im[14]                                |
| s0bf1\under{}fsr\under{}re[1] |           x\under{}re[4] - x\under{}re[12]           |                                x\under{}re[5] - x\under{}re[13]                                |
| s0bf1\under{}fsr\under{}im[1] |           x\under{}im[4] - x\under{}im[12]           |                                x\under{}im[5] - x\under{}im[13]                                |
| s0bf1\under{}fsr\under{}re[2] |           x\under{}re[3] - x\under{}re[11]           |                                x\under{}re[4] - x\under{}re[12]                                |
| s0bf1\under{}fsr\under{}im[2] |           x\under{}im[3] - x\under{}im[11]           |                                x\under{}im[4] - x\under{}im[12]                                |
| s0bf1\under{}fsr\under{}re[3] |           x\under{}re[2] - x\under{}re[10]           |                                x\under{}re[3] - x\under{}re[11]                                |
| s0bf1\under{}fsr\under{}im[3] |           x\under{}im[2] - x\under{}im[10]           |                                x\under{}im[3] - x\under{}im[11]                                |
| s0bf1\under{}fsr\under{}re[4] |           x\under{}re[1] - x\under{}re[9]            |                                x\under{}re[2] - x\under{}re[10]                                |
| s0bf1\under{}fsr\under{}im[4] |           x\under{}im[1] - x\under{}im[9]            |                                x\under{}im[2] - x\under{}im[10]                                |
| s0bf1\under{}fsr\under{}re[5] |           x\under{}re[0] - x\under{}re[8]            |                                x\under{}re[1] - x\under{}re[9]                                 |
| s0bf1\under{}fsr\under{}im[5] |           x\under{}im[0] - x\under{}im[8]            |                                x\under{}im[1] - x\under{}im[9]                                 |
| s0bf1\under{}fsr\under{}re[6] |                x\under{}re[7]                 |                                x\under{}re[0] - x\under{}re[8]                                 |
| s0bf1\under{}fsr\under{}im[6] |                x\under{}im[7]                 |                                x\under{}im[0] - x\under{}im[8]                                 |
| s0bf1\under{}fsr\under{}re[7] |                x\under{}re[6]                 |                                     x\under{}re[7]                                      |
| s0bf1\under{}fsr\under{}im[7] |                x\under{}im[6]                 |                                     x\under{}im[7]                                      |
|-----------------+----------------------------------------+----------------------------------------------------------------------------------|
| s0bf2\under{}fsr\under{}re[0] | x\under{}re[1] + x\under{}re[9] - x\under{}re[5] - x\under{}re[13] |                     x\under{}re[2] + x\under{}re[10] - x\under{}re[6] - x\under{}re[14]                      |
| s0bf2\under{}fsr\under{}im[0] | x\under{}im[1] + x\under{}im[9] - x\under{}im[5] - x\under{}im[13] |                     x\under{}im[2] + x\under{}im[10] - x\under{}im[6] - x\under{}im[14]                      |
| s0bf2\under{}fsr\under{}re[1] | x\under{}re[0] + x\under{}re[8] - x\under{}re[4] - x\under{}re[12] |                      x\under{}re[1] + x\under{}re[9] - x\under{}re[5] - x\under{}re[13]                      |
| s0bf2\under{}fsr\under{}im[1] | x\under{}im[0] + x\under{}im[8] - x\under{}im[4] - x\under{}im[12] |                      x\under{}im[1] + x\under{}im[9] - x\under{}im[5] - x\under{}im[13]                      |
| s0bf2\under{}fsr\under{}re[2] |           x\under{}re[3] + x\under{}re[11]           |                      x\under{}re[0] + x\under{}re[8] - x\under{}re[4] - x\under{}re[12]                      |
| s0bf2\under{}fsr\under{}im[2] |           x\under{}im[3] + x\under{}im[11]           |                      x\under{}im[0] + x\under{}im[8] - x\under{}im[4] - x\under{}im[12]                      |
| s0bf2\under{}fsr\under{}re[3] |           x\under{}re[2] + x\under{}re[10]           |                                x\under{}re[3] + x\under{}re[11]                                |
| s0bf2\under{}fsr\under{}im[3] |           x\under{}im[2] + x\under{}im[10]           |                                x\under{}im[3] + x\under{}im[11]                                |
|-----------------+----------------------------------------+----------------------------------------------------------------------------------|
| s1bf1\under{}fsr\under{}re[0] | x\under{}re[1] + x\under{}re[9] + x\under{}re[5] + x\under{}re[13] | x\under{}re[0] + x\under{}re[8] + x\under{}re[4] + x\under{}re[12] - x\under{}re[2] - x\under{}re[10] - x\under{}re[6] - x\under{}re[14] |
| s1bf1\under{}fsr\under{}im[0] | x\under{}im[1] + x\under{}im[9] + x\under{}im[5] + x\under{}im[13] | x\under{}im[0] + x\under{}im[8] + x\under{}im[4] + x\under{}im[12] - x\under{}im[2] - x\under{}im[10] - x\under{}im[6] - x\under{}im[14] |
| s1bf1\under{}fsr\under{}re[1] | x\under{}re[0] + x\under{}re[8] + x\under{}re[4] + x\under{}re[12] |                      x\under{}re[1] + x\under{}re[9] + x\under{}re[5] + x\under{}re[13]                      |
| s1bf1\under{}fsr\under{}im[1] | x\under{}im[0] + x\under{}im[8] + x\under{}im[4] + x\under{}im[12] |                      x\under{}im[1] + x\under{}im[9] + x\under{}im[5] + x\under{}im[13]                      |
|-----------------+----------------------------------------+----------------------------------------------------------------------------------|
| s1bf2\under{}fsr\under{}re[0] |                                        | x\under{}re[0] + x\under{}re[8] + x\under{}re[4] + x\under{}re[12] + x\under{}re[2] + x\under{}re[10] + x\under{}re[6] + x\under{}re[14] |
| s1bf2\under{}fsr\under{}im[0] |                                        | x\under{}im[0] + x\under{}im[8] + x\under{}im[4] + x\under{}im[12] + x\under{}im[2] + x\under{}im[10] + x\under{}im[6] + x\under{}im[14] |

\begin{latex}
\tikzset{
  s0bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/7,1.65/6,2.05/5,2.45/4,2.85/3,3.25/2,3.65/1,4.05/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45,2.85,3.25,3.65,4.05} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,-,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-,color=white] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-,color=white] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5) node[left] {\texttt{x\_re(15) ... x\_re(1) x\_re(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:7)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5) node[left] {\texttt{x\_im(15) ... x\_im(1) x\_im(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:8)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel0i}$};
  }
}
\tikzset{
  s0bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/3,1.65/2,2.05/1,2.45/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,--,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:5.4)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:6.4)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel0ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,color=white,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right,color=white]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel0i}$};
    \draw (myand.in 2) to[short,-*,color=white] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-,color=white] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\tikzset{
  s1bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/1,1.65/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,-,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-,color=white] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-,color=white] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:2.5);
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.6)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1)
      to[short,-,color=white] ++(180:1.5) --++(90:0.85) --++(180:1);
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.6)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel1i}$};
  }
}
\tikzset{
  s1bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,--,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.2)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.2)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel1ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,color=white,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right,color=white]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel1i}$};
    \draw (myand.in 2) to[short,-*,color=white] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-,color=white] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\begin{inctext}
\begin{circuitikz}
  %%% stage 0 BF1
  \path(0,0) pic{s0bf1};
  %%% stage 0 BF2
  \path(7,0) pic{s0bf2};
  %%% mixer
  \draw (12,-2) node[mixer,color=white,scale=1.5] (mix0) {};
  \draw (mix0.south) node[inputarrow,rotate=90,color=white] --++(0,-1)
    node[below] {\texttt{W1(n)}};
  \draw (mix0.east)++(-0.08,0.25) to[short,-,l=$\texttt{re}$] ++(0.85,0) node[inputarrow,color=white];
  \draw (mix0.east)++(-0.08,-0.25) to[short,-,l=$\texttt{im}$] ++(0.85,0) node[inputarrow,color=white];
  %%% register
  \draw (13.5,-2) to[twoport,t=\texttt{REG},color=white] (14.5,-2);
  \fill[white] (14-0.1,-2.5) --++(0.2,0) --++(-0.1,0.2) --cycle;
  \draw(15,-1.8) node[above] {\texttt{re}};
  \draw(15,-2.2) node[below] {\texttt{im}};
  %%% stage 1 BF1
  \path(18,0) pic{s1bf1};
  %%% stage 1 BF2
  \path(25,0) pic{s1bf2};

\end{circuitikz}
\end{inctext}
\end{latex}

sel0i  : 9-16
sel0ii : 13-24
sel1i  : 15-28
sel1ii : 16-30

twiddle factors:
w(0)  :  1.000-0.000j
w(1)  :  1.000-0.000j
w(2)  :  1.000-0.000j
w(3)  :  1.000-0.000j
w(4)  :  1.000-0.000j
w(5)  :  0.707-0.707j
w(6)  :  0.000-1.000j
w(7)  : -0.707-0.707j
w(8)  :  1.000-0.000j
w(9)  :  0.923-0.382j
w(10) :  0.707-0.707j
w(11) :  0.382-0.923j
w(12) :  1.000-0.000j
w(13) :  0.382-0.923j
w(14) : -0.707-0.707j
w(15) : -0.923+0.382j

|               t |                                       ...                                        |                                                                                 16                                                                                  |
|             <r> |                                       <c>                                        |                                                                                 <c>                                                                                 |
|-----------------+----------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|           sel0i |                                        1                                         |                                                                                  1                                                                                  |
|          sel0ii |                                        1                                         |                                                                                  1                                                                                  |
|           sel1i |                                        1                                         |                                                                                  1                                                                                  |
|          sel1ii |                                                                                  |                                                                                  1                                                                                  |
|               w |                                       w(2)                                       |                                                                                w(3)                                                                                 |
|         dout\under{}re |                                                                                  | x\under{}re[0] + x\under{}re[8] + x\under{}re[4] + x\under{}re[12] + x\under{}re[2] + x\under{}re[10] + x\under{}re[6] + x\under{}re[14] + x\under{}re[1] + x\under{}re[9] + x\under{}re[5] + x\under{}re[13] + x\under{}re[3] + x\under{}re[11] + x\under{}re[7] + x\under{}re[15] |
|         dout\under{}im |                                                                                  | x\under{}im[0] + x\under{}im[8] + x\under{}im[4] + x\under{}im[12] + x\under{}im[2] + x\under{}im[10] + x\under{}im[6] + x\under{}im[14] + x\under{}im[1] + x\under{}im[9] + x\under{}im[5] + x\under{}im[13] + x\under{}im[3] + x\under{}im[11] + x\under{}im[7] + x\under{}im[15] |
|        freq bin |                                                                                  |                                                                                  0                                                                                  |
|-----------------+----------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| s0bf1\under{}fsr\under{}re[0] |                                x\under{}re[6] - x\under{}re[14]                                |                                                                         x\under{}re[7] - x\under{}re[15]                                                                          |
| s0bf1\under{}fsr\under{}im[0] |                                x\under{}im[6] - x\under{}im[14]                                |                                                                         x\under{}im[7] - x\under{}im[15]                                                                          |
| s0bf1\under{}fsr\under{}re[1] |                                x\under{}re[5] - x\under{}re[13]                                |                                                                         x\under{}re[6] - x\under{}re[14]                                                                          |
| s0bf1\under{}fsr\under{}im[1] |                                x\under{}im[5] - x\under{}im[13]                                |                                                                         x\under{}im[6] - x\under{}im[14]                                                                          |
| s0bf1\under{}fsr\under{}re[2] |                                x\under{}re[4] - x\under{}re[12]                                |                                                                         x\under{}re[5] - x\under{}re[13]                                                                          |
| s0bf1\under{}fsr\under{}im[2] |                                x\under{}im[4] - x\under{}im[12]                                |                                                                         x\under{}im[5] - x\under{}im[13]                                                                          |
| s0bf1\under{}fsr\under{}re[3] |                                x\under{}re[3] - x\under{}re[11]                                |                                                                         x\under{}re[4] - x\under{}re[12]                                                                          |
| s0bf1\under{}fsr\under{}im[3] |                                x\under{}im[3] - x\under{}im[11]                                |                                                                         x\under{}im[4] - x\under{}im[12]                                                                          |
| s0bf1\under{}fsr\under{}re[4] |                                x\under{}re[2] - x\under{}re[10]                                |                                                                         x\under{}re[3] - x\under{}re[11]                                                                          |
| s0bf1\under{}fsr\under{}im[4] |                                x\under{}im[2] - x\under{}im[10]                                |                                                                         x\under{}im[3] - x\under{}im[11]                                                                          |
| s0bf1\under{}fsr\under{}re[5] |                                x\under{}re[1] - x\under{}re[9]                                 |                                                                         x\under{}re[2] - x\under{}re[10]                                                                          |
| s0bf1\under{}fsr\under{}im[5] |                                x\under{}im[1] - x\under{}im[9]                                 |                                                                         x\under{}im[2] - x\under{}im[10]                                                                          |
| s0bf1\under{}fsr\under{}re[6] |                                x\under{}re[0] - x\under{}re[8]                                 |                                                                          x\under{}re[1] - x\under{}re[9]                                                                          |
| s0bf1\under{}fsr\under{}im[6] |                                x\under{}im[0] - x\under{}im[8]                                 |                                                                          x\under{}im[1] - x\under{}im[9]                                                                          |
| s0bf1\under{}fsr\under{}re[7] |                                     x\under{}re[7]                                      |                                                                          x\under{}re[0] - x\under{}re[8]                                                                          |
| s0bf1\under{}fsr\under{}im[7] |                                     x\under{}im[7]                                      |                                                                          x\under{}im[0] - x\under{}im[8]                                                                          |
|-----------------+----------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| s0bf2\under{}fsr\under{}re[0] |                     x\under{}re[2] + x\under{}re[10] - x\under{}re[6] - x\under{}re[14]                      |                                                               x\under{}re[3] + x\under{}re[11] - x\under{}re[7] - x\under{}re[15]                                                               |
| s0bf2\under{}fsr\under{}im[0] |                     x\under{}im[2] + x\under{}im[10] - x\under{}im[6] - x\under{}im[14]                      |                                                               x\under{}im[3] + x\under{}im[11] - x\under{}im[7] - x\under{}im[15]                                                               |
| s0bf2\under{}fsr\under{}re[1] |                      x\under{}re[1] + x\under{}re[9] - x\under{}re[5] - x\under{}re[13]                      |                                                               x\under{}re[2] + x\under{}re[10] - x\under{}re[6] - x\under{}re[14]                                                               |
| s0bf2\under{}fsr\under{}im[1] |                      x\under{}im[1] + x\under{}im[9] - x\under{}im[5] - x\under{}im[13]                      |                                                               x\under{}im[2] + x\under{}im[10] - x\under{}im[6] - x\under{}im[14]                                                               |
| s0bf2\under{}fsr\under{}re[2] |                      x\under{}re[0] + x\under{}re[8] - x\under{}re[4] - x\under{}re[12]                      |                                                               x\under{}re[1] + x\under{}re[9] - x\under{}re[5] - x\under{}re[13]                                                                |
| s0bf2\under{}fsr\under{}im[2] |                      x\under{}im[0] + x\under{}im[8] - x\under{}im[4] - x\under{}im[12]                      |                                                               x\under{}im[1] + x\under{}im[9] - x\under{}im[5] - x\under{}im[13]                                                                |
| s0bf2\under{}fsr\under{}re[3] |                                x\under{}re[3] + x\under{}re[11]                                |                                                               x\under{}re[0] + x\under{}re[8] - x\under{}re[4] - x\under{}re[12]                                                                |
| s0bf2\under{}fsr\under{}im[3] |                                x\under{}im[3] + x\under{}im[11]                                |                                                               x\under{}im[0] + x\under{}im[8] - x\under{}im[4] - x\under{}im[12]                                                                |
|-----------------+----------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| s1bf1\under{}fsr\under{}re[0] | x\under{}re[0] + x\under{}re[8] + x\under{}re[4] + x\under{}re[12] - x\under{}re[2] - x\under{}re[10] - x\under{}re[6] - x\under{}re[14] |                                          x\under{}re[1] + x\under{}re[9] + x\under{}re[5] + x\under{}re[13] - x\under{}re[3] - x\under{}re[11] - x\under{}re[7] - x\under{}re[15]                                           |
| s1bf1\under{}fsr\under{}im[0] | x\under{}im[0] + x\under{}im[8] + x\under{}im[4] + x\under{}im[12] - x\under{}im[2] - x\under{}im[10] - x\under{}im[6] - x\under{}im[14] |                                          x\under{}im[1] + x\under{}im[9] + x\under{}im[5] + x\under{}im[13] - x\under{}im[3] - x\under{}im[11] - x\under{}im[7] - x\under{}im[15]                                           |
| s1bf1\under{}fsr\under{}re[1] |                      x\under{}re[1] + x\under{}re[9] + x\under{}re[5] + x\under{}re[13]                      |                                          x\under{}re[0] + x\under{}re[8] + x\under{}re[4] + x\under{}re[12] - x\under{}re[2] - x\under{}re[10] - x\under{}re[6] - x\under{}re[14]                                           |
| s1bf1\under{}fsr\under{}im[1] |                      x\under{}im[1] + x\under{}im[9] + x\under{}im[5] + x\under{}im[13]                      |                                          x\under{}im[0] + x\under{}im[8] + x\under{}im[4] + x\under{}im[12] - x\under{}im[2] - x\under{}im[10] - x\under{}im[6] - x\under{}im[14]                                           |
|-----------------+----------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| s1bf2\under{}fsr\under{}re[0] | x\under{}re[0] + x\under{}re[8] + x\under{}re[4] + x\under{}re[12] + x\under{}re[2] + x\under{}re[10] + x\under{}re[6] + x\under{}re[14] | x\under{}re[0] + x\under{}re[8] + x\under{}re[4] + x\under{}re[12] + x\under{}re[2] + x\under{}re[10] + x\under{}re[6] + x\under{}re[14] - x\under{}re[1] - x\under{}re[9] - x\under{}re[5] - x\under{}re[13] - x\under{}re[3] - x\under{}re[11] - x\under{}re[7] - x\under{}re[15] |
| s1bf2\under{}fsr\under{}im[0] | x\under{}im[0] + x\under{}im[8] + x\under{}im[4] + x\under{}im[12] + x\under{}im[2] + x\under{}im[10] + x\under{}im[6] + x\under{}im[14] | x\under{}im[0] + x\under{}im[8] + x\under{}im[4] + x\under{}im[12] + x\under{}im[2] + x\under{}im[10] + x\under{}im[6] + x\under{}im[14] - x\under{}im[1] - x\under{}im[9] - x\under{}im[5] - x\under{}im[13] - x\under{}im[3] - x\under{}im[11] - x\under{}im[7] - x\under{}im[15] |

\begin{latex}
\tikzset{
  s0bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/7,1.65/6,2.05/5,2.45/4,2.85/3,3.25/2,3.65/1,4.05/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45,2.85,3.25,3.65,4.05} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,-,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-,color=white] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-,color=white] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5) node[left] {\texttt{x\_re(15) ... x\_re(1) x\_re(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:7)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5) node[left] {\texttt{x\_im(15) ... x\_im(1) x\_im(0)}};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:8)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel0i}$};
  }
}
\tikzset{
  s0bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/3,1.65/2,2.05/1,2.45/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65,2.05,2.45} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,--,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:5.4)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:6.4)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel0ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,color=white,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right,color=white]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel0i}$};
    \draw (myand.in 2) to[short,-*,color=white] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-,color=white] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\tikzset{
  s1bf1/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/1,1.65/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    \foreach \y in {1.65} {
      \draw (0.6875,\y-0.1) node[inputarrow,rotate=180,color=white] (0.6875,\y-0.1);
      \draw (0.6875,\y-0.1) --++(0:0.5) --++(90:0.2) --++(180:0.5);
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,-,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.125)--++(1.15,0);
    \draw ($(A)!0.5!(B)$)++(2.9,-3.775) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)++(0:2.5)++(0,-2.125)
      to[short,*-,color=white] ++(0,-1.65) --++(1.15,0);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)++(0:2)--++(0,-1.2525)--++(1.65,0);
    \draw ($(A)!0.5!(B)$)++(0:2)++(0,-1.2525)
      to[short,*-,color=white] ++(0,-0.9) --++(1.65,0);
    %%\draw ($(A)!0.5!(B)$)++(3.1,-1.2525) node[below] {\texttt{-}};
    \draw ($(A)!0.5!(B)$)--++(0:2);
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:2.5);
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.6)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1)
      to[short,-,color=white] ++(180:1.5) --++(90:0.85) --++(180:1);
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.6)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:0.25) node[below,font=\small]{$\texttt{sel1i}$};
  }
}
\tikzset{
  s1bf2/.pic={
    %% shift regs
    \foreach \y/\i in {1.25/0} {
      \draw (-0.3125,\y) rectangle ++(1,0.4);
      \draw (0.1875,\y+0.2) node[font=\tiny] {\texttt{fsr[\i]}};
      \fill[white] (0.1875-0.05,\y) --++(0.1,0) --++(-0.05,0.1) --cycle;
    }
    %% xfsr re
    \draw (0,0)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.35) to[short,-,l=$\texttt{re}$] (-2,1.35) -- (-2,0.66);
    \draw (-1.75,0.66) to[short,*-,color=white] (-1.75,-2.6)
      --++(1.30675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0) node[inputarrow,color=white];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33)
      to[short,--,color=white] ++(180:1);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2.5)--++(0,-2.25)--++(1.37,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% xfsr im
    \draw (0,-1.25)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw (-0.3125,1.55) to[short,-] (-2.5,1.55)
      ++(1.15625,0) node[above] {\texttt{im}} ++(-1.15625,0)
      -- (-2.5,0.66-1.25);
    \draw (-2.25,0.66-1.25) to[short,*-,color=white] (-2.25,-3.85)
      --++(1.80675,0) --++(0,0.25) node[inputarrow,rotate=90,color=white];
    \draw ($(C)!0.33!(O)$) --++(180:1) ++(-0.05,0)
      node[inputarrow,color=white] --++(180:1.45);
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:2)--++(0,-1.55)--++(1.9,0) node[inputarrow,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x re
    \draw (0,-2.5)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:2) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.55) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1.75) ++(0,0) node[above left] {\texttt{re}}
      ++(0,0) --++(90:4.2)--++(180:2.25)--++(-90:0.55) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) to[short,-*,color=white] ++(-90:1.25);

    %% x im
    \draw (0,-3.75)coordinate (O)--++(30:0.5)coordinate (A)--++(90:0.5)coordinate (B)--++(150:0.5)coordinate (C)--cycle;
    % 0 input
    \draw ($(C)!0.33!(O)$)--++(180:1) to[short,-,color=white] ++(180:1.5)
      ++(-0.425,-0.5) coordinate (O1)--++(30:0.5)coordinate (A1)--++(90:0.5)coordinate (B1)--++(150:0.5)coordinate (C1)--cycle;
    \draw ($(C1)!0.33!(O1)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{0}$};
    \draw ($(C1)!0.66!(O1)$)++(180:0.0625) node[right,font=\small] {$\texttt{1}$};
    \draw ($(C)!0.33!(O)$) ++(180:1.5) to[short,*-,color=white] ++(90:1.5)
      --++(0:1.05) --++(90:0.45) node[inputarrow,color=white,rotate=90];
    \draw ($(C)!0.33!(O)$)++(180:0.0625) node[right,font=\small] {$\texttt{0}$};
    % 1 input
    \draw ($(C)!0.66!(O)$)--++(180:0.25) ++(180:0.2)
      node[adder,color=white,scale=0.4,name=A1BF1] {}
      (A1BF1.west) ++(-0.2,-0.2) node[] {\texttt{-}}
      (A1BF1.west) node[inputarrow,color=white] --++(180:0.35)
      to[short,-*,color=white] ++(90:0.33);
      node[left] {\texttt{0}};
    \draw ($(C)!0.66!(O)$)++(180:0.0625) node[right,font=\small,color=pink] {$\texttt{1}$};
    % output
    \draw ($(A)!0.5!(B)$)--++(0:1) ++(0,0) node[above left] {\texttt{im}}
      ++(0,0) --++(90:5.2)--++(180:1)--++(-90:0.3) node[inputarrow,rotate=-90,color=white];
    % sel
    \draw ($(O)!0.5!(A)$)--++(-90:0.25) --++(0:0.5) --++(-90:1) node[right,font=\small]{$\texttt{sel1ii}$};

    %% sel and tsel
    \draw ($(O)!0.5!(A)$)++(-1.5,-0.75) node[and port,rotate=180,color=white,scale=0.5] (myand) {};
    \node at (myand.in 1) [ocirc,right,color=white]{};
    \draw (myand.in 1) --++(0.5,0) --++(0,-0.36) node[below,font=\small] {$\texttt{sel1i}$};
    \draw (myand.in 2) to[short,-*,color=white] ++(1.3,0);
    \draw (myand.out) --++(-1.35,0) to[short,*-,color=white] ++(0,0) --++(0,0.92);
    \draw (myand.out) ++(-1.35,0) --++(-0.5,0)--++(0,1.9)--++(0.5,0)--++(0,0.25);
  }
}
\begin{inctext}
\begin{circuitikz}
  %%% stage 0 BF1
  \path(0,0) pic{s0bf1};
  %%% stage 0 BF2
  \path(7,0) pic{s0bf2};
  %%% mixer
  \draw (12,-2) node[mixer,color=white,scale=1.5] (mix0) {};
  \draw (mix0.south) node[inputarrow,rotate=90,color=white] --++(0,-1)
    node[below] {\texttt{W1(n)}};
  \draw (mix0.east)++(-0.08,0.25) to[short,-,l=$\texttt{re}$] ++(0.85,0) node[inputarrow,color=white];
  \draw (mix0.east)++(-0.08,-0.25) to[short,-,l=$\texttt{im}$] ++(0.85,0) node[inputarrow,color=white];
  %%% register
  \draw (13.5,-2) to[twoport,t=\texttt{REG},color=white] (14.5,-2);
  \fill[white] (14-0.1,-2.5) --++(0.2,0) --++(-0.1,0.2) --cycle;
  \draw(15,-1.8) node[above] {\texttt{re}};
  \draw(15,-2.2) node[below] {\texttt{im}};
  %%% stage 1 BF1
  \path(18,0) pic{s1bf1};
  %%% stage 1 BF2
  \path(25,0) pic{s1bf2};

\end{circuitikz}
\end{inctext}
\end{latex}

sel0i  : 9-16
sel0ii : 13-24
sel1i  : 15-28
sel1ii : 16-30

twiddle factors:
w(0)  :  1.000-0.000j
w(1)  :  1.000-0.000j
w(2)  :  1.000-0.000j
w(3)  :  1.000-0.000j
w(4)  :  1.000-0.000j
w(5)  :  0.707-0.707j
w(6)  :  0.000-1.000j
w(7)  : -0.707-0.707j
w(8)  :  1.000-0.000j
w(9)  :  0.923-0.382j
w(10) :  0.707-0.707j
w(11) :  0.382-0.923j
w(12) :  1.000-0.000j
w(13) :  0.382-0.923j
w(14) : -0.707-0.707j
w(15) : -0.923+0.382j

|               t |                                                       17                                                        |
|             <r> |                                                       <c>                                                       |
|-----------------+-----------------------------------------------------------------------------------------------------------------|
|           sel0i |                                                        0                                                        |
|          sel0ii |                                                        1                                                        |
|           sel1i |                                                        1                                                        |
|          sel1ii |                                                        1                                                        |
|               w |                                                      w(4)                                                       |
|         dout\under{}re |                                                                                                                 |
|         dout\under{}im |                                                                                                                 |
|        freq bin |                                                        8                                                        |
|-----------------+-----------------------------------------------------------------------------------------------------------------|
| s0bf1\under{}fsr\under{}re[0] |                                                        -                                                        |
| s0bf1\under{}fsr\under{}im[0] |                                                        -                                                        |
| s0bf1\under{}fsr\under{}re[1] |                                               x\under{}re[7] - x\under{}re[15]                                                |
| s0bf1\under{}fsr\under{}im[1] |                                               x\under{}im[7] - x\under{}im[15]                                                |
| s0bf1\under{}fsr\under{}re[2] |                                               x\under{}re[6] - x\under{}re[14]                                                |
| s0bf1\under{}fsr\under{}im[2] |                                               x\under{}im[6] - x\under{}im[14]                                                |
| s0bf1\under{}fsr\under{}re[3] |                                               x\under{}re[5] - x\under{}re[13]                                                |
| s0bf1\under{}fsr\under{}im[3] |                                               x\under{}im[5] - x\under{}im[13]                                                |
| s0bf1\under{}fsr\under{}re[4] |                                               x\under{}re[4] - x\under{}re[12]                                                |
| s0bf1\under{}fsr\under{}im[4] |                                               x\under{}im[4] - x\under{}im[12]                                                |
| s0bf1\under{}fsr\under{}re[5] |                                               x\under{}re[3] - x\under{}re[11]                                                |
| s0bf1\under{}fsr\under{}im[5] |                                               x\under{}im[3] - x\under{}im[11]                                                |
| s0bf1\under{}fsr\under{}re[6] |                                               x\under{}re[2] - x\under{}re[10]                                                |
| s0bf1\under{}fsr\under{}im[6] |                                               x\under{}im[2] - x\under{}im[10]                                                |
| s0bf1\under{}fsr\under{}re[7] |                                                x\under{}re[1] - x\under{}re[9]                                                |
| s0bf1\under{}fsr\under{}im[7] |                                                x\under{}im[1] - x\under{}im[9]                                                |
|-----------------+-----------------------------------------------------------------------------------------------------------------|
| s0bf2\under{}fsr\under{}re[0] |                           x\under{}re[1] + x\under{}re[9] - x\under{}re[5] - x\under{}re[13] - x\under{}im[1] + x\under{}im[9]                            |
| s0bf2\under{}fsr\under{}im[0] |                           x\under{}im[1] + x\under{}im[9] - x\under{}im[5] - x\under{}im[13] + x\under{}re[1] - x\under{}re[9]                            |
| s0bf2\under{}fsr\under{}re[1] |                                     x\under{}re[3] + x\under{}re[11] - x\under{}re[7] - x\under{}re[15]                                     |
| s0bf2\under{}fsr\under{}im[1] |                                     x\under{}im[3] + x\under{}im[11] - x\under{}im[7] - x\under{}im[15]                                     |
| s0bf2\under{}fsr\under{}re[2] |                                     x\under{}re[2] + x\under{}re[10] - x\under{}re[6] - x\under{}re[14]                                     |
| s0bf2\under{}fsr\under{}im[2] |                                     x\under{}im[2] + x\under{}im[10] - x\under{}im[6] - x\under{}im[14]                                     |
| s0bf2\under{}fsr\under{}re[3] |                                     x\under{}re[1] + x\under{}re[9] - x\under{}re[5] - x\under{}re[13]                                      |
| s0bf2\under{}fsr\under{}im[3] |                                     x\under{}im[1] + x\under{}im[9] - x\under{}im[5] - x\under{}im[13]                                      |
|-----------------+-----------------------------------------------------------------------------------------------------------------|
| s1bf1\under{}fsr\under{}re[0] |              2*x\under{}re[5] + 2*x\under{}re[13] - x\under{}re[3] - x\under{}re[11] - x\under{}re[7] - x\under{}re[15] - x\under{}im[1] + x\under{}im[9]               |
| s1bf1\under{}fsr\under{}im[0] |              2*x\under{}im[5] + 2*x\under{}im[13] - x\under{}im[3] - x\under{}im[11] - x\under{}im[7] - x\under{}im[15] + x\under{}re[1] - x\under{}re[9]               |
| s1bf1\under{}fsr\under{}re[1] |                x\under{}re[1] + x\under{}re[9] + x\under{}re[5] + x\under{}re[13] - x\under{}re[3] - x\under{}re[11] - x\under{}re[7] - x\under{}re[15]                 |
| s1bf1\under{}fsr\under{}im[1] |                x\under{}im[1] + x\under{}im[9] + x\under{}im[5] + x\under{}im[13] - x\under{}im[3] - x\under{}im[11] - x\under{}im[7] - x\under{}im[15]                 |
|-----------------+-----------------------------------------------------------------------------------------------------------------|
| s1bf2\under{}fsr\under{}re[0] | x\under{}re[0] + x\under{}re[8] + x\under{}re[4] + x\under{}re[12] + x\under{}re[2] + x\under{}re[10] + x\under{}re[6] + x\under{}re[14] - x\under{}re[7] - x\under{}re[15] + x\under{}im[7] |
| s1bf2\under{}fsr\under{}im[0] |                                                                                                                 |

** graphical rendering
The host PC takes the range/angle data from the FPGA and plots it
using matplotlib. See [[https://matplotlib.org/3.1.1/api/animation_api.html][this example]] and the [[https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.animation.FuncAnimation.html#matplotlib.animation.FuncAnimation][FuncAnimation]] documentation
for how to perform realtime plots with matplotlib. The host PC
simultaneously plots the realtime range and angle (using a polar plot,
where each point is a dB strength) and an incrementally updated (also
realtime) range-time plot. It provides the option to record both.

* antennas
